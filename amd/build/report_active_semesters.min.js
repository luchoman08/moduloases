'use strict';define(['jquery','block_ases/Chart','block_ases/loading_indicator','block_ases/jquery.dataTables','block_ases/dataTables.autoFill','block_ases/dataTables.buttons','block_ases/buttons.html5','block_ases/buttons.flash','block_ases/buttons.print'],function(a,b,c){function e(x,y){var z=[],A;for(A=0;A<y.length;A++)x.includes(y[A])&&z.push(A);return z}function f(x,y,z){a('#tableActiveSemesters tfoot th').html(''),a('#tableActiveSemesters tfoot tr.total_active th')[0].textContent='Total activos'+' '+z,a('#tableActiveSemesters tfoot tr.total_inactive th')[0].textContent='Total inactivos'+' '+z,y.forEach(function(A){a('#tableActiveSemesters tfoot tr.total_active th.'+A).html(x[A]),a('#tableActiveSemesters tfoot tr.total_inactive th.'+A).html(x.total_students-x[A])})}function g(x,y){return x.filter(function(z){return-1!==y.indexOf(z)}).length===y.length}function h(){var x=document.getElementById('active_semesters_chart').toDataURL();a('#download_percentage_desertion').click(function(){a(this).attr('href',x)})}function k(x,y,z){var A=[];x.forEach(function(E){A.push(y[E])});var C=document.getElementById('active_semesters_chart'),D=C.getContext('2d');window.myLine=new b(D,{type:'line',data:{labels:x,datasets:[{label:'Porcentaje de estudiantes inactivos durante el periodo',backgroundColor:'red',borderColor:'red',data:A,fill:!1}]},options:{animation:{onComplete:function onComplete(){z()}},responsive:!0,title:{display:!0,text:'Reporte deserci\xF3n'},tooltips:{mode:'index',intersect:!1},hover:{mode:'nearest',intersect:!0},scales:{xAxes:[{display:!0,scaleLabel:{display:!0,labelString:'Periodo'}}],yAxes:[{display:!0,scaleLabel:{display:!0,labelString:'Porcentaje'}}]}}})}function l(x,y){c.show();a.ajax({method:'POST',url:'../managers/report_active_semesters/report_active_semesters_api.php',data:{function:'data_table',params:{instance_id:y,cohort_id:x}},dataType:'json'}).done(function(B){c.hide(),console.log(B,'data');var C=B.dataTable;a('#download_percentage_desertion').css('display','inline'),s=B.semesters;var D=C.columns.map(function(F){return F.name}),E=C.data.length;v=new u(s,E),v.init_from_data(C.data,s),w=new t(v,s),k(s,w,h),C.rowCallback=function(F,G){a(s).each(function(I,J){'SI'===G[J]&&a('td.'+J,F).addClass('active_semester')})},C.initComplete=function(){var F=C.columns.map(function(I){return I.name?I.name:null}),G=s;G.push('cambio_carrera');var H=e(G,F);this.api().columns(H).every(function(){var I=this,J=a('<select><option value=""></option></select>').appendTo(a(I.header())).on('change',function(){var K=a.fn.dataTable.util.escapeRegex(a(this).val());I.search(K?'^'+K+'$':'',!0,!1).draw()});I.data().unique().sort().each(function(K){J.append('<option value="'+K+'">'+K+'</option>')})})},a.fn.dataTable.isDataTable('#tableActiveSemesters')&&(a('#div_table_report').html(''),a('#div_table_report').fadeIn(1e3).append('<table id="tableActiveSemesters" class="table" cellspacing="0" width="100%"></table>')),table=a('#tableActiveSemesters').DataTable(C),a('#tableActiveSemesters').append(a('<tfoot/>').append(a('#tableActiveSemesters thead tr').clone().addClass('total_active'))),a('#tableActiveSemesters').append(a('<tfoot/>').append(a('#tableActiveSemesters thead tr').clone().addClass('total_inactive'))),f(v,s,x),g(D,r)||console.error(' Las columnas dadas no coinciden con las columnas conocidas.','columnas daads:',D,'columnas conocidas: ',r)}).fail(function(B){console.log(B),c.hide()})}var r=['codigo','nombre','num_doc'],s=[],t=function(){return function(y,z){var B=this,A=y.total_students;z.forEach(function(C){var D=A-y[C];B[C]=100*D/A})}}(),u=function(){function x(y,z){var A=this;this.total_students=z?z:0,y.forEach(function(B){A[B]=0})}return x.prototype.init_from_data=function(z,A){var B=this;z.forEach(function(C){A.forEach(function(D){'SI'===C[D]&&B[D]++})})},x}(),v=null,w=null;return{init:function init(x){var y=x.instance_id;a(document).on('click','#tableActiveSemesters tbody tr td',function(){var C=a('#tableActiveSemesters').DataTable(),D=C.cell(this).index().column;if(0<=D&&2>=D){var E='student_profile.php'+location.search+'&student_code='+C.cell(C.row(this).index(),0).data(),F=window.open(E,'_blank');F.focus()}}),a('#cohorts').change(function(){var B=a('#cohorts option:selected').val();l(B,y)});var A=a('#cohorts option:selected').val();l(A,y)}}});